
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas - Presta Express</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header img {
            width: 80px;
            height: auto;
            margin-bottom: 15px;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .main-content {
            padding: 40px;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .step.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .step.active .step-number {
            background: white;
            color: #ff6b35;
        }
        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #ff6b35;
            display: none;
        }
        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-section h2 {
            color: #ff6b35;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .carta-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .carta-option {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .carta-option:hover {
            border-color: #ff6b35;
            background: #fff5f2;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.15);
        }
        .carta-option.selected {
            border-color: #ff6b35;
            background: linear-gradient(135deg, #fff5f2 0%, #ffffff 100%);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
        }
        .carta-option .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .carta-option h3 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .carta-option p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .form-col {
            flex: 1;
            min-width: 300px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3);
        }
        .btn-secondary {
            background: white;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }
        .btn-secondary:hover {
            background: #ff6b35;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .letter-output {
            display: none;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .letter-content {
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            color: #333;
            font-size: 11pt;
        }
        .letter-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .letter-header img {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }
        .letter-body {
            text-align: left;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        .letter-body p {
            margin-bottom: 15px;
        }
        .letter-signature {
            margin-top: 50px;
            text-align: center;
        }
        .signature-line {
            border-top: 1pt solid #333;
            width: 300px;
            margin: 40px auto 10px;
        }
        .copropietarios-section {
            background: #fff5f2;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #ff6b35;
        }
        .copropietario-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .copropietario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff6b35;
        }
        .copropietario-header h4 {
            color: #ff6b35;
            margin: 0;
        }
        .toggle-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        .hidden {
            display: none;
        }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            width: 33%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                min-width: 100%;
            }
            
            .carta-selector {
                grid-template-columns: 1fr;
            }
            
            .button-group, .navigation-buttons {
                flex-direction: column;
            }
            
            .step-indicator {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
            <h1>Generador de Cartas</h1>
            <p>Sistema de generaci√≥n autom√°tica de documentos legales</p>
        </div>
        
        <div class="main-content">
            <!-- Indicador de Pasos -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <span>Tipo de Carta</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <span>Datos Requeridos</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <span>Generar Documento</span>
                </div>
            </div>

            <!-- Barra de Progreso -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Paso 1: Selecci√≥n de Carta -->
            <div class="form-section active" id="seleccion-carta">
                <h2>üìÑ Selecciona el Tipo de Carta</h2>
                <p style="color: #666; margin-bottom: 25px;">Elige el tipo de documento que necesitas generar:</p>
                
                <div class="carta-selector">
                    <div class="carta-option" data-carta="gift-card">
                        <div class="icon">üéÅ</div>
                        <h3>Carta de Regalo</h3>
                        <p>Gift Card por tiempo de espera durante proceso de gesti√≥n</p>
                    </div>
                    
                    <div class="carta-option" data-carta="constancia">
                        <div class="icon">üìã</div>
                        <h3>Constancia de Fondos</h3>
                        <p>Certificaci√≥n del origen de fondos para transacciones</p>
                    </div>
                    
                    <div class="carta-option" data-carta="cheque">
                        <div class="icon">üí≥</div>
                        <h3>Cheque Retenido</h3>
                        <p>Solicitud de traslado de cheque retenido al saldo</p>
                    </div>
                    
                    <div class="carta-option" data-carta="transferencia">
                        <div class="icon">üè¶</div>
                        <h3>Autorizaci√≥n de Transferencia</h3>
                        <p>Autorizaci√≥n para transferencias bancarias</p>
                    </div>
                    
                    <div class="carta-option" data-carta="terceros">
                        <div class="icon">üë•</div>
                        <h3>Cheques a Terceros</h3>
                        <p>Autorizaci√≥n para cheques a nombre de terceras personas</p>
                    </div>
                    
                    <div class="carta-option" data-carta="ordenes-pago">
                        <div class="icon">üí∞</div>
                        <h3>√ìrdenes de Pago</h3>
                        <p>Carta de √≥rdenes de pago y aval√∫o</p>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn btn-primary" onclick="siguientePaso()" id="btnSiguiente" disabled>
                        Continuar ‚Üí
                    </button>
                </div>
            </div>

            <!-- Paso 2: Campos Din√°micos -->
            <div class="form-section" id="campos-datos">
                <h2 id="titulo-carta">üìã Completa los Datos</h2>
                <div id="campos-container"></div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="pasoAnterior()">
                        ‚Üê Atr√°s
                    </button>
                    <button class="btn btn-primary" onclick="siguientePaso()">
                        Continuar ‚Üí
                    </button>
                </div>
            </div>

            <!-- Paso 3: Generar Carta -->
            <div class="form-section" id="generar-carta">
                <h2>üöÄ Generar Documento</h2>
                <p style="color: #666; margin-bottom: 25px;">Revisa los datos y genera tu carta:</p>
                
                <div id="resumen-datos" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e0e0e0;"></div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="pasoAnterior()">
                        ‚Üê Atr√°s
                    </button>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-primary" onclick="generarCarta()">
                            üöÄ Generar Carta
                        </button>
                        <button class="btn btn-secondary" onclick="nuevaCarta()">
                            üìÑ Nueva Carta
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resultado -->
            <div id="letterOutput" class="letter-output">
                <div class="letter-content" id="letterContent"></div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="imprimirCarta()">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button class="btn btn-secondary" onclick="copiarCarta()">
                        üìã Copiar Texto
                    </button>
                    <button class="btn btn-secondary" onclick="nuevaCarta()">
                        üìÑ Nueva Carta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        let selectedCarta = '';
        let copropietarios = [];
        let contadorCopropietarios = 0;
        let retenciones = [];
        let contadorRetenciones = 0;
        let datosGuardados = {}; // Para mantener datos entre cartas

        // FUNCIONES GLOBALES DEFINIDAS AL INICIO
        window.toggleRetenciones = function() {
            console.log('toggleRetenciones llamada');
            const section = document.getElementById('retencionesSection');
            console.log('Secci√≥n encontrada:', section);
            if (section) {
                section.classList.toggle('hidden');
                console.log('Clases despu√©s del toggle:', section.classList);
            } else {
                console.error('No se encontr√≥ retencionesSection');
            }
        };

        window.agregarRetencion = function() {
            console.log('agregarRetencion llamada');
            contadorRetenciones++;
            const retencion = {
                id: contadorRetenciones,
                nombre: '',
                monto: ''
            };
            
            retenciones.push(retencion);
            console.log('Retenciones actuales:', retenciones);
            window.renderizarRetenciones();
        };

        window.eliminarRetencion = function(id) {
            console.log('Eliminando retenci√≥n:', id);
            retenciones = retenciones.filter(r => r.id !== id);
            window.renderizarRetenciones();
        };

        window.actualizarRetencion = function(id, campo, valor) {
            console.log('Actualizando retenci√≥n:', id, campo, valor);
            const retencion = retenciones.find(r => r.id === id);
            if (retencion) {
                retencion[campo] = valor;
                console.log('Retenci√≥n actualizada:', retencion);
            }
        };

        window.renderizarRetenciones = function() {
            console.log('renderizarRetenciones llamada');
            const container = document.getElementById('retencionesList');
            console.log('Container encontrado:', container);
            if (!container) return;
            
            container.innerHTML = '';
            
            retenciones.forEach((retencion, index) => {
                console.log('Renderizando retenci√≥n:', retencion);
                container.innerHTML += `
                    <div class="copropietario-item">
                        <div class="copropietario-header">
                            <h4>Retenci√≥n ${index + 3}</h4>
                            <button type="button" class="btn btn-danger" onclick="eliminarRetencion(${retencion.id})">
                                Eliminar
                            </button>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Nombre de la Retenci√≥n:</label>
                                    <input type="text" onchange="actualizarRetencion(${retencion.id}, 'nombre', this.value)" 
                                           value="${retencion.nombre}" placeholder="Ej: RETENER HASTA TENER CERTIFICACI√ìN DE...">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Monto (Q):</label>
                                    <input type="number" step="0.01" onchange="actualizarRetencion(${retencion.id}, 'monto', this.value)" 
                                           value="${retencion.monto}" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            console.log('Retenciones renderizadas');
        };

        window.toggleCopropietarios = function() {
            const section = document.getElementById('copropietariosSection');
            if (section) {
                section.classList.toggle('hidden');
            }
        };

        window.agregarCopropietario = function() {
            contadorCopropietarios++;
            const copropietario = {
                id: contadorCopropietarios,
                nombre: '',
                edad: '',
                estadoCivil: 'casado',
                nacionalidad: 'guatemalteco/a',
                profesion: 'comerciante',
                dpi: ''
            };
            
            copropietarios.push(copropietario);
            window.renderizarCopropietarios();
        };

        window.eliminarCopropietario = function(id) {
            copropietarios = copropietarios.filter(c => c.id !== id);
            window.renderizarCopropietarios();
        };

        window.actualizarCopropietario = function(id, campo, valor) {
            const copropietario = copropietarios.find(c => c.id === id);
            if (copropietario) {
                copropietario[campo] = valor;
            }
        };

        window.renderizarCopropietarios = function() {
            const container = document.getElementById('copropietariosList');
            if (!container) return;
            
            container.innerHTML = '';
            
            copropietarios.forEach((coprop, index) => {
                container.innerHTML += `
                    <div class="copropietario-item">
                        <div class="copropietario-header">
                            <h4>Copropietario ${index + 1}</h4>
                            <button type="button" class="btn btn-danger" onclick="eliminarCopropietario(${coprop.id})">
                                Eliminar
                            </button>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Nombre Completo:</label>
                                    <input type="text" onchange="actualizarCopropietario(${coprop.id}, 'nombre', this.value)" value="${coprop.nombre}">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Edad:</label>
                                    <input type="number" onchange="actualizarCopropietario(${coprop.id}, 'edad', this.value)" value="${coprop.edad}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Estado Civil:</label>
                                    <select onchange="actualizarCopropietario(${coprop.id}, 'estadoCivil', this.value)">
                                        <option value="soltero" ${coprop.estadoCivil === 'soltero' ? 'selected' : ''}>Soltero</option>
                                        <option value="soltera" ${coprop.estadoCivil === 'soltera' ? 'selected' : ''}>Soltera</option>
                                        <option value="casado" ${coprop.estadoCivil === 'casado' ? 'selected' : ''}>Casado</option>
                                        <option value="casada" ${coprop.estadoCivil === 'casada' ? 'selected' : ''}>Casada</option>
                                        <option value="divorciado" ${coprop.estadoCivil === 'divorciado' ? 'selected' : ''}>Divorciado</option>
                                        <option value="divorciada" ${coprop.estadoCivil === 'divorciada' ? 'selected' : ''}>Divorciada</option>
                                        <option value="viudo" ${coprop.estadoCivil === 'viudo' ? 'selected' : ''}>Viudo</option>
                                        <option value="viuda" ${coprop.estadoCivil === 'viuda' ? 'selected' : ''}>Viuda</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>DPI:</label>
                                    <input type="text" maxlength="15" oninput="formatearDPI(this)" onchange="actualizarCopropietario(${coprop.id}, 'dpi', this.value)" value="${coprop.dpi}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        };


        window.toggleNombreCuenta = function() {
    const tipoSelect = document.getElementById('tipoNombreCuenta');
    const nombreInput = document.getElementById('nombreCuenta');
    
    if (tipoSelect && nombreInput) {
        if (tipoSelect.value === 'otro') {
            nombreInput.style.display = 'block';
            nombreInput.required = true;
        } else {
            nombreInput.style.display = 'none';
            nombreInput.required = false;
            nombreInput.value = '';
        }
    }
};

        // Configuraci√≥n de campos por tipo de carta
        const camposPorCarta = {
            'gift-card': {
                titulo: 'üéÅ Carta de Regalo (Gift Card)',
                campos: ['basicos', 'giftcard']
            },
            'constancia': {
                titulo: 'üìã Constancia de Fondos',
                campos: ['basicos', 'financieros', 'empresa']
            },
            'cheque': {
                titulo: 'üí≥ Cheque Retenido al Saldo',
                campos: ['basicos', 'empresa', 'cheque']
            },
            'transferencia': {
                titulo: 'üè¶ Autorizaci√≥n de Transferencia',
                campos: ['basicos', 'empresa', 'transferencia']
            },
            'terceros': {
                titulo: 'üë• Autorizaci√≥n de Cheques a Terceros',
                campos: ['basicos', 'empresa', 'terceros']
            },
            'ordenes-pago': {
                titulo: 'üí∞ Carta de √ìrdenes de Pago y Aval√∫o',
                campos: ['basicos', 'empresa', 'ordenes']
            }
        };

        // N√∫meros a letras en espa√±ol
        const numerosLetras = {
            0: 'cero', 1: 'uno', 2: 'dos', 3: 'tres', 4: 'cuatro', 5: 'cinco',
            6: 'seis', 7: 'siete', 8: 'ocho', 9: 'nueve', 10: 'diez',
            11: 'once', 12: 'doce', 13: 'trece', 14: 'catorce', 15: 'quince',
            16: 'diecis√©is', 17: 'diecisiete', 18: 'dieciocho', 19: 'diecinueve',
            20: 'veinte', 21: 'veintiuno', 22: 'veintid√≥s', 23: 'veintitr√©s',
            24: 'veinticuatro', 25: 'veinticinco', 26: 'veintis√©is', 27: 'veintisiete',
            28: 'veintiocho', 29: 'veintinueve', 30: 'treinta', 40: 'cuarenta',
            50: 'cincuenta', 60: 'sesenta', 70: 'setenta', 80: 'ochenta', 90: 'noventa'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado - iniciando aplicaci√≥n');
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            datosGuardados.fecha = today;
            console.log('Fecha establecida:', today);

            // Event listeners para selecci√≥n de carta
            document.querySelectorAll('.carta-option').forEach(option => {
                option.addEventListener('click', function() {
                    console.log('Carta seleccionada:', this.dataset.carta);
                    
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.carta-option').forEach(opt => opt.classList.remove('selected'));
                    
                    // Seleccionar nueva carta
                    this.classList.add('selected');
                    selectedCarta = this.dataset.carta;
                    
                    console.log('Variable selectedCarta actualizada:', selectedCarta);
                    
                    // Habilitar bot√≥n siguiente
                    const btnSiguiente = document.getElementById('btnSiguiente');
                    btnSiguiente.disabled = false;
                    console.log('Bot√≥n siguiente habilitado');
                });
            });
            
            console.log('Event listeners configurados');
        });

        // Navegaci√≥n entre pasos
        function siguientePaso() {
            console.log('Paso actual:', currentStep, 'Carta seleccionada:', selectedCarta);
            
            if (currentStep === 1 && selectedCarta) {
                console.log('Avanzando al paso 2 - generando campos');
                generarCamposDinamicos();
                cambiarPaso(2);
            } else if (currentStep === 2) {
                console.log('Validando campos del paso 2');
                if (validarCampos()) {
                    console.log('Campos v√°lidos, guardando datos');
                    guardarDatos();
                    mostrarResumen();
                    cambiarPaso(3);
                } else {
                    console.log('Campos inv√°lidos');
                    alert('Por favor completa todos los campos requeridos.');
                }
            } else {
                console.log('Condici√≥n no cumplida - currentStep:', currentStep, 'selectedCarta:', selectedCarta);
            }
        }

        function pasoAnterior() {
            if (currentStep === 2) {
                cambiarPaso(1);
            } else if (currentStep === 3) {
                cambiarPaso(2);
            }
        }

        function cambiarPaso(paso) {
            // Ocultar todos los pasos
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Actualizar indicadores
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Mostrar paso actual
            currentStep = paso;
            document.getElementById(`step${paso}`).classList.add('active');
            
            // Actualizar barra de progreso
            const progress = (paso - 1) * 50;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Mostrar secci√≥n correspondiente
            if (paso === 1) {
                document.getElementById('seleccion-carta').classList.add('active');
            } else if (paso === 2) {
                document.getElementById('campos-datos').classList.add('active');
            } else if (paso === 3) {
                document.getElementById('generar-carta').classList.add('active');
            }
        }

        // Generar campos din√°micos seg√∫n tipo de carta
        function generarCamposDinamicos() {
            console.log('Generando campos para:', selectedCarta);
            
            if (!selectedCarta) {
                console.error('No hay carta seleccionada');
                return;
            }
            
            const config = camposPorCarta[selectedCarta];
            if (!config) {
                console.error('Configuraci√≥n no encontrada para:', selectedCarta);
                return;
            }
            
            console.log('Configuraci√≥n encontrada:', config);
            
            document.getElementById('titulo-carta').textContent = config.titulo;
            
            const container = document.getElementById('campos-container');
            container.innerHTML = '';
            
            config.campos.forEach(grupoCampos => {
                console.log('Generando grupo:', grupoCampos);
                const grupoElement = generarGrupoCampos(grupoCampos);
                container.appendChild(grupoElement);
            });
            
            // Llenar campos con datos guardados despu√©s de crear el DOM
            setTimeout(() => {
                llenarCamposGuardados();
            }, 100);
            
            console.log('Campos generados correctamente');
        }

        function generarGrupoCampos(tipo) {
            const div = document.createElement('div');
            div.className = 'form-section active';
            div.style.display = 'block';
            
            switch (tipo) {
                case 'basicos':
                    div.innerHTML = `
                        <h2>üë§ Informaci√≥n Personal</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="nombreCompleto">Nombre Completo *</label>
                                    <input type="text" id="nombreCompleto" placeholder="Ej: Juan Carlos P√©rez Garc√≠a" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="edad">Edad (n√∫meros) *</label>
                                    <input type="number" id="edad" placeholder="Ej: 35" required oninput="convertirEdadLetras()">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="edadLetras">Edad (letras)</label>
                                    <input type="text" id="edadLetras" placeholder="Se genera autom√°ticamente" readonly>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="estadoCivil">Estado Civil *</label>
                                    <select id="estadoCivil" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="soltero">Soltero</option>
                                        <option value="soltera">Soltera</option>
                                        <option value="casado">Casado</option>
                                        <option value="casada">Casada</option>
                                        <option value="divorciado">Divorciado</option>
                                        <option value="divorciada">Divorciada</option>
                                        <option value="viudo">Viudo</option>
                                        <option value="viuda">Viuda</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="nacionalidad">Nacionalidad</label>
                                    <input type="text" id="nacionalidad" value="guatemalteco/a">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="profesion">Profesi√≥n</label>
                                    <input type="text" id="profesion" value="comerciante">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="dpi">DPI (n√∫meros) *</label>
                                    <input type="text" id="dpi" placeholder="Ej: 2641 60932 0901" maxlength="15" required oninput="formatearDPI(this)">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="dpiLetras">DPI (letras)</label>
                                    <textarea id="dpiLetras" rows="2" placeholder="Se genera autom√°ticamente" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fecha">Fecha del Documento</label>
                            <input type="date" id="fecha">
                        </div>

                        ${(selectedCarta !== 'gift-card') ? `
                        <button type="button" class="toggle-btn" onclick="toggleCopropietarios()">
                            üë• Agregar Copropietarios
                        </button>
                        
                        <div id="copropietariosSection" class="copropietarios-section hidden">
                            <div class="alert">
                                <strong>Informaci√≥n:</strong> Los copropietarios aparecer√°n en las cartas que lo requieran autom√°ticamente.
                            </div>
                            <div id="copropietariosList"></div>
                            <button type="button" class="btn btn-secondary" onclick="agregarCopropietario()">
                                + Agregar Copropietario
                            </button>
                        </div>
                        ` : ''}
                    `;
                    break;

                case 'empresa':
                    div.innerHTML = `
                        <h2>üè¢ Empresa Destinataria</h2>
                        <div class="form-group">
                            <label for="empresa">Empresa Destinataria *</label>
                            <select id="empresa" required>
                                <option value="HOLLEM, SOCIEDAD AN√ìNIMA.">HOLLEM, SOCIEDAD AN√ìNIMA.</option>
                                <option value="PRESTA EXPRESS, SOCIEDAD AN√ìNIMA.">PRESTA EXPRESS, SOCIEDAD AN√ìNIMA.</option>
                                <option value="otra">Otra (escribir manualmente)</option>
                            </select>
                            <input type="text" id="empresaOtra" style="display: none; margin-top: 10px;" placeholder="Escribir nombre de la empresa">
                        </div>
                    `;
                    break;

                case 'financieros':
                    div.innerHTML = `
                        <h2>üí∞ Informaci√≥n Financiera</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="monto">Monto *</label>
                                    <input type="text" id="monto" placeholder="Ej: 175000 o Q175,000.00" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="numeroEscritura">N√∫mero de Escritura *</label>
                                    <input type="text" id="numeroEscritura" placeholder="Ej: 437" required>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'giftcard':
                    div.innerHTML = `
                        <h2>üéÅ Datos de Gift Card</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="valorGiftCard">Valor Gift Card (Q) *</label>
                                    <input type="number" id="valorGiftCard" placeholder="100.00" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="nombreAsesor">Nombre del Asesor *</label>
                                    <input type="text" id="nombreAsesor" placeholder="Nombre del asesor" required>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'cheque':
                    div.innerHTML = `
                        <h2>üí≥ Datos del Cheque</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="numeroCheque">N√∫mero de Cheque *</label>
                                    <input type="text" id="numeroCheque" placeholder="Ej: 123456" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="monto">Monto del Cheque *</label>
                                    <input type="text" id="monto" placeholder="Ej: 5000.00" required>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'transferencia':
                    div.innerHTML = `
                        <h2>üè¶ Datos de Transferencia</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="numeroCuenta">N√∫mero de Cuenta *</label>
                                    <input type="text" id="numeroCuenta" placeholder="Ej: 1490192513" required>
                                </div>
                            </div>
                            <div class="form-row">
    <div class="form-col">
        <div class="form-group">
            <label for="banco">Banco *</label>
            <input type="text" id="banco" placeholder="Ej: Banco Industrial" required>
        </div>
    </div>
    <div class="form-col">
        <div class="form-group">
            <label for="nombreCuenta">Nombre de la Cuenta *</label>
            <select id="tipoNombreCuenta" onchange="toggleNombreCuenta()" required>
                <option value="">Seleccionar...</option>
                <option value="mismo">Mismo nombre del cliente</option>
                <option value="otro">Otro nombre</option>
            </select>
            <input type="text" id="nombreCuenta" style="display: none; margin-top: 10px;" placeholder="Escribir nombre de la cuenta">
        </div>
    </div>
</div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="numeroEscritura">N√∫mero de Escritura *</label>
                                    <input type="text" id="numeroEscritura" placeholder="Ej: 422" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="notario">Notario</label>
                                    <input type="text" id="notario" value="Mar√≠a Olga Arce Godoy">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tipoContrato">Tipo de Contrato</label>
                            <select id="tipoContrato">
                                <option value="MUTUO, GARANT√çA HIPOTECARIA">MUTUO, GARANT√çA HIPOTECARIA</option>
                                <option value="MUTUO">MUTUO</option>
                                <option value="MUTUO CON GARANT√çA HIPOTECARIA">MUTUO CON GARANT√çA HIPOTECARIA</option>
                            </select>
                        </div>
                    `;
                    break;

                case 'terceros':
                    div.innerHTML = `
                        <h2>üë• Datos del Tercero</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="nombreTercero">Nombre del Tercero *</label>
                                    <input type="text" id="nombreTercero" placeholder="Ej: Angelo Jos√© Javier Hidalgo Rodriguez" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="edadTercero">Edad del Tercero *</label>
                                    <input type="number" id="edadTercero" placeholder="Ej: 31" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="estadoCivilTercero">Estado Civil del Tercero *</label>
                                    <select id="estadoCivilTercero" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="soltero">Soltero</option>
                                        <option value="soltera">Soltera</option>
                                        <option value="casado">Casado</option>
                                        <option value="casada">Casada</option>
                                        <option value="divorciado">Divorciado</option>
                                        <option value="divorciada">Divorciada</option>
                                        <option value="viudo">Viudo</option>
                                        <option value="viuda">Viuda</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="dpiTercero">DPI del Tercero *</label>
                                    <input type="text" id="dpiTercero" placeholder="Ej: 2558 39901 0101" maxlength="15" required oninput="formatearDPI(this)">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
    <label for="tipoContrato">Tipo de Contrato *</label>
    <select id="tipoContrato" required>
        <option value="">Seleccionar...</option>
        <option value="MUTUO" selected>MUTUO</option>
        <option value="MUTUO, GARANT√çA HIPOTECARIA">MUTUO, GARANT√çA HIPOTECARIA</option>
    </select>
</div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="numeroEscritura">N√∫mero de Escritura *</label>
                                    <input type="text" id="numeroEscritura" placeholder="Ej: 359" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="notario">Notario</label>
                                    <input type="text" id="notario" value="Mar√≠a Olga Arce Godoy">
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'ordenes':
                    div.innerHTML = `
                        <h2>üí∞ Datos de √ìrdenes de Pago</h2>
                        <div class="form-group">
                            <label for="tipoContrato">Tipo de Contrato *</label>
                            <select id="tipoContrato" required>
                                <option value="">Seleccionar...</option>
                                <option value="MUTUO">MUTUO</option>
                                <option value="MUTUO CON GARANT√çA HIPOTECARIA" selected>MUTUO CON GARANT√çA HIPOTECARIA</option>
                                <option value="MUTUO CON GARANT√çA HIPOTECARIA GARANTIA">MUTUO CON GARANT√çA HIPOTECARIA GARANTIA</option>
                                <option value="MUTUO, GARANT√çA HIPOTECARIA">MUTUO, GARANT√çA HIPOTECARIA</option>
                            </select>
                        </div>
                        
                        <h3 style="color: #ff6b35; margin: 25px 0 15px;">Retenciones</h3>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="montoRetencion1">Monto Retenci√≥n 1 - Registro y Aval√∫o (Q)</label>
                                    <input type="number" id="montoRetencion1" value="30000" step="0.01">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="montoRetencion2">Monto Retenci√≥n 2 - Nomenclatura (Q)</label>
                                    <input type="number" id="montoRetencion2" value="2000" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="toggle-btn" onclick="toggleRetenciones()">
                            üí∞ Agregar M√°s Retenciones
                        </button>
                        
                        <div id="retencionesSection" class="copropietarios-section hidden">
                            <div class="alert">
                                <strong>Informaci√≥n:</strong> Puedes agregar retenciones adicionales con nombre y monto personalizados.
                            </div>
                            <div id="retencionesList"></div>
                            <button type="button" class="btn btn-secondary" onclick="agregarRetencion()">
                                + Agregar Retenci√≥n
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="notario">Notario</label>
                            <input type="text" id="notario" value="Mar√≠a Olga Arce Godoy">
                        </div>
                    `;
                    break;
            }
            
            return div;
        }

        // Funciones auxiliares (mantener todas las funciones de conversi√≥n, formateo, etc.)
        function numeroALetras(numero) {
            if (numero === 0) return 'cero';
            if (numero <= 30) return numerosLetras[numero];
            if (numero < 100) {
                const decenas = Math.floor(numero / 10) * 10;
                const unidades = numero % 10;
                if (unidades === 0) {
                    return numerosLetras[decenas];
                } else if (unidades === 1) {
                    return numerosLetras[decenas] + ' y un';
                } else {
                    return numerosLetras[decenas] + ' y ' + numerosLetras[unidades];
                }
            }
            return numero.toString();
        }

        function convertirEdadLetras() {
            const edad = parseInt(document.getElementById('edad').value);
            if (edad) {
                document.getElementById('edadLetras').value = numeroALetras(edad);
            }
        }

        function formatearDPI(input) {
            let valor = input.value.replace(/\s/g, '');
            valor = valor.replace(/[^\d]/g, '');
            
            let formateado = '';
            if (valor.length <= 4) {
                formateado = valor;
            } else if (valor.length <= 9) {
                formateado = valor.substring(0, 4) + ' ' + valor.substring(4);
            } else if (valor.length <= 13) {
                formateado = valor.substring(0, 4) + ' ' + valor.substring(4, 9) + ' ' + valor.substring(9);
            }
            
            input.value = formateado;
            
            if (valor.length === 13) {
                convertirDPILetras(input);
            }
        }

       function numeroALetrasDPI(num) {
    if (num === 0) return 'cero';
    
    const unidades = ['', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
    const decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
    const especiales = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'diecis√©is', 'diecisiete', 'dieciocho', 'diecinueve'];
    const veintes = ['veinte', 'veintiuno', 'ventidos', 'veintitr√©s', 'veinticuatro', 'veinticinco', 'veintis√©is', 'veintisiete', 'veintiocho', 'veintinueve'];
    const centenas = ['', 'ciento', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];

    if (num === 100) return 'cien';

    let resultado = '';

    if (num >= 1000) {
        const miles = Math.floor(num / 1000);
        if (miles === 1) {
            resultado += 'mil ';
        } else {
            resultado += numeroALetrasDPI(miles) + ' mil ';
        }
        num = num % 1000;
    }

    if (num >= 100) {
        resultado += centenas[Math.floor(num / 100)] + ' ';
        num = num % 100;
    }

    if (num >= 20 && num <= 29) {
        resultado += veintes[num - 20]; // Para 20-29 usar la forma junta
    } else if (num >= 30) {
        resultado += decenas[Math.floor(num / 10)];
        if (num % 10 > 0) {
            resultado += ' y ' + unidades[num % 10];
        }
    } else if (num >= 10) {
        resultado += especiales[num - 10];
    } else if (num > 0) {
        resultado += unidades[num];
    }

    return resultado.trim();
}
        function convertirDPILetras(input) {
            let dpi = input.value.replace(/\s/g, '');
            if (dpi.length === 13) {
                const grupo1 = dpi.substring(0, 4);
                const grupo2 = dpi.substring(4, 9);
                const grupo3 = dpi.substring(9, 13);
                
               // Para el grupo 3, verificar si empieza con cero
let letras3;
if (grupo3.startsWith('0')) {
    const resto = parseInt(grupo3.substring(1)); // Quitar el primer cero
    if (resto === 0) {
        letras3 = 'cero cero cero cero';
    } else {
        letras3 = 'cero ' + numeroALetrasDPI(resto);
    }
} else {
    letras3 = numeroALetrasDPI(parseInt(grupo3));
}

const letras1 = numeroALetrasDPI(parseInt(grupo1));
const letras2 = numeroALetrasDPI(parseInt(grupo2));
                
                if (input.id === 'dpi') {
                    document.getElementById('dpiLetras').value = 
                        `n√∫mero ${letras1} espacio ${letras2} espacio ${letras3}`;
                }
            }
        }

        function convertirNumeroCompleto(num) {
            if (num === 0) return 'cero';
            
            let resultado = '';
            
            if (num >= 1000) {
                const miles = Math.floor(num / 1000);
                const resto = num % 1000;
                
                if (miles === 1) {
                    resultado = 'mil';
                } else {
                    resultado = convertirCentenas(miles) + ' mil';
                }
                
                if (resto > 0) {
                    resultado += ' ' + convertirCentenas(resto);
                }
            } else {
                resultado = convertirCentenas(num);
            }
            
            return resultado;
        }

        function convertirCentenas(num) {
            if (num === 0) return '';
            if (num < 100) return convertirDecenas(num);
            
            const centenas = Math.floor(num / 100);
            const resto = num % 100;
            
            const nombresCentenas = {
                1: resto === 0 ? 'cien' : 'ciento',
                2: 'doscientos', 3: 'trescientos', 4: 'cuatrocientos', 5: 'quinientos',
                6: 'seiscientos', 7: 'setecientos', 8: 'ochocientos', 9: 'novecientos'
            };
            
            let resultado = nombresCentenas[centenas];
            if (resto > 0) {
                resultado += ' ' + convertirDecenas(resto);
            }
            
            return resultado;
        }

        function convertirDecenas(num) {
            if (num < 30) return numerosLetras[num] || '';
            
            const decenas = Math.floor(num / 10) * 10;
            const unidades = num % 10;
            
            if (unidades === 0) {
                return numerosLetras[decenas];
            } else if (unidades === 1) {
                return numerosLetras[decenas] + ' y un';
            } else {
                return numerosLetras[decenas] + ' y ' + numerosLetras[unidades];
            }
        }

        // Llenar campos con datos guardados
        function llenarCamposGuardados() {
            // Llenar campos b√°sicos
            Object.keys(datosGuardados).forEach(campo => {
                const element = document.getElementById(campo);
                if (element && datosGuardados[campo]) {
                    element.value = datosGuardados[campo];
                    
                    // Actualizar campos dependientes
                    if (campo === 'edad' && datosGuardados[campo]) {
                        setTimeout(() => convertirEdadLetras(), 100);
                    }
                    if (campo === 'dpi' && datosGuardados[campo]) {
                        setTimeout(() => formatearDPI(element), 100);
                    }
                }
            });

            // Configurar fecha por defecto si no hay una guardada
            const fechaElement = document.getElementById('fecha');
            if (fechaElement && !datosGuardados.fecha) {
                const today = new Date().toISOString().split('T')[0];
                fechaElement.value = today;
                datosGuardados.fecha = today;
            }

            // Configurar eventos espec√≠ficos despu√©s de generar el DOM
            setTimeout(() => {
                const empresaSelect = document.getElementById('empresa');
                if (empresaSelect) {
                    empresaSelect.addEventListener('change', function() {
                        const empresaOtra = document.getElementById('empresaOtra');
                        if (empresaOtra) {
                            if (this.value === 'otra') {
                                empresaOtra.style.display = 'block';
                                empresaOtra.required = true;
                            } else {
                                empresaOtra.style.display = 'none';
                                empresaOtra.required = false;
                                empresaOtra.value = '';
                            }
                        }
                    });
                }
                
                // Si ya hay una empresa guardada y es "otra", mostrar el campo
                if (datosGuardados.empresa === 'otra' && datosGuardados.empresaOtra) {
                    const empresaOtra = document.getElementById('empresaOtra');
                    if (empresaOtra) {
                        empresaOtra.style.display = 'block';
                        empresaOtra.value = datosGuardados.empresaOtra;
                    }
                }
            }, 200);
        }

        // Validar campos requeridos
        function validarCampos() {
            const requiredFields = document.querySelectorAll('#campos-container input[required], #campos-container select[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            return true;
        }

        // Guardar datos del formulario
        function guardarDatos() {
            const inputs = document.querySelectorAll('#campos-container input, #campos-container select, #campos-container textarea');
            inputs.forEach(input => {
                if (input.value) {
                    datosGuardados[input.id] = input.value;
                }
            });
            
            // Guardar retenciones adicionales en los datos
            datosGuardados.retencionesAdicionales = retenciones;
        }

        // Mostrar resumen de datos
        function mostrarResumen() {
            const resumen = document.getElementById('resumen-datos');
            const config = camposPorCarta[selectedCarta];
            
            let html = `<h3>${config.titulo}</h3><hr style="margin: 15px 0;"><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">`;
            
            // Mostrar datos principales
            if (datosGuardados.nombreCompleto) {
                html += `<p><strong>Nombre:</strong> ${datosGuardados.nombreCompleto}</p>`;
            }
            if (datosGuardados.edadLetras) {
                html += `<p><strong>Edad:</strong> ${datosGuardados.edadLetras} a√±os</p>`;
            }
            if (datosGuardados.estadoCivil) {
                html += `<p><strong>Estado Civil:</strong> ${datosGuardados.estadoCivil}</p>`;
            }
            if (datosGuardados.dpi) {
                html += `<p><strong>DPI:</strong> ${datosGuardados.dpi}</p>`;
            }
            
            // Datos espec√≠ficos por tipo de carta
            if (selectedCarta === 'gift-card' && datosGuardados.valorGiftCard) {
                html += `<p><strong>Valor Gift Card:</strong> Q${datosGuardados.valorGiftCard}</p>`;
            }
            if (datosGuardados.monto) {
                html += `<p><strong>Monto:</strong> ${datosGuardados.monto}</p>`;
            }
            if (datosGuardados.empresa) {
                html += `<p><strong>Empresa:</strong> ${datosGuardados.empresa}</p>`;
            }
            
            html += '</div>';
            resumen.innerHTML = html;
        }

        // Generar la carta
        function generarCarta() {
            let fechaFormateada;
            if (datosGuardados.fecha) {
                const fecha = new Date(datosGuardados.fecha + 'T00:00:00');
                fechaFormateada = 'Guatemala, ' + fecha.toLocaleDateString('es-GT', { 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                }) + '.';
            } else {
                fechaFormateada = 'Guatemala, ' + new Date().toLocaleDateString('es-GT', { 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                }) + '.';
            }

            let contenido = '';
            
            switch (selectedCarta) {
                case 'gift-card':
                    contenido = generarGiftCard(datosGuardados, fechaFormateada);
                    break;
                case 'constancia':
                    contenido = generarConstanciaFondos(datosGuardados, fechaFormateada);
                    break;
                case 'cheque':
                    contenido = generarChequeRetenido(datosGuardados, fechaFormateada);
                    break;
                case 'transferencia':
                    contenido = generarAutorizacionTransferencia(datosGuardados, fechaFormateada);
                    break;
                case 'terceros':
                    contenido = generarAutorizacionTerceros(datosGuardados, fechaFormateada);
                    break;
                case 'ordenes-pago':
                    contenido = generarOrdenesPago(datosGuardados, fechaFormateada);
                    break;
            }

            document.getElementById('letterContent').innerHTML = contenido;
            document.getElementById('letterOutput').style.display = 'block';
            document.getElementById('letterOutput').scrollIntoView({ behavior: 'smooth' });
        }

        // Funciones de generaci√≥n de cartas (mantener las mismas del c√≥digo anterior)
        function generarGiftCard(datos, fecha) {
            return `
                <div class="letter-header">
                    <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
                </div>
                
                <div style="margin-bottom: 40px;">
<p><strong>Fecha: ${fecha.replace('Guatemala, ', '').replace('.', '')}</strong></p>                    <p></p>
<p><strong>Nombre de Beneficiario: ${(datos.nombreCompleto || '').toUpperCase()}</strong></p>

                    <p></p>
<p><strong>DPI: ${formatearDPIDisplay(datos.dpi || '')}</strong></p>

                </div>
                
                <div class="letter-body">
                    <p></p>
<p>Por medio de la presente, hago constar que he recibido una tarjeta de regalo (Gift Card) con un valor de Q${datos.valorGiftCard || ''},

                    <p></p>
                    <p>Reconozco que esta Gift Card no forma parte del monto desembolsado ni del contrato de pr√©stamo hipotecario otorgado, y que he recibido dicha tarjeta a satisfacci√≥n.</p>
                </div>
                
                <div style="margin-top: 80px;">
                    <p>Firma: ________________________________</p>
                    <p></p>
                    <p></p>
                    <p></p>
                    <p></p>
                    <p></p>
                    <p style="text-align: center;">
                        <br>
                        <br>
                        <br>
                        <br>
                        ________________________________<br>
<strong>${(datos.nombreAsesor || 'Nombre de Asesor').toUpperCase()}</strong>
                    </p>
                </div>
            `;
        }

        function generarConstanciaFondos(datos, fecha) {
            const numeroEscrituraEnLetras = numeroALetrasCompleto(parseInt(datos.numeroEscritura || 0));
            const montoFormateado = formatearMonto(datos.monto || '0');
            const genero = detectarGenero(datos.nombreCompleto || '');
            const tratamiento = genero === 'femenino' ? 'Sra' : 'Sr';
            
            return `
                <div class="letter-header">
                    <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
                </div>
                
                <div style="text-align: left; margin-bottom: 30px;">
                    <strong>${fecha}</strong>
                </div>
                
                <div class="letter-body">
                    <p><strong>Se√±ores:</strong></p>
                    <p><strong>Presentes</strong></p>
                    <p></p>
                    <p><strong>Estimado jefe de Agencia,</strong></p>
                    <p></p>
                    <p>Espero que esta carta le encuentre bien. Me dirijo a usted para proporcionar informaci√≥n sobre la procedencia de los fondos del <strong>${tratamiento}. ${datos.nombreCompleto || ''}</strong>, de ${datos.edadLetras || ''} a√±os, ${datos.estadoCivil || ''}, ${datos.nacionalidad || ''}, ${datos.profesion || ''}, de este domicilio, quien me identifico con el Documento Personal de Identificaci√≥n (DPI) con C√≥digo √önico de Identificaci√≥n (CUI) ${datos.dpiLetras || ''}.</p>
                    <p></p>
                    <p>El origen de los fondos proviene de la autorizaci√≥n de cr√©dito con garant√≠a hipotecaria / <strong>Presta Express</strong>.</p>
                    <p></p>
                    <p>De escritura n√∫mero ${numeroEscrituraEnLetras} (${datos.numeroEscritura || ''}) por un monto de ${montoFormateado} los cuales se componen de gastos administrativos, legales y l√≠quido del cliente.</p>
                    <p></p>
                    <p>Quedo a su disposici√≥n para cualquier consulta adicional y agradezco su pronta respuesta, para la confirmaci√≥n de esta carta pueden comunicarse al n√∫mero 2425-9700 al departamento de contabilidad.</p>
                    <p></p>
                    <p><strong>Atentamente,</strong></p>
                </div>
                
                <div class="letter-signature">
                    <div class="signature-line"></div>
                    <p><strong>EMELY LIZETH JIMENEZ FLORIAN</strong></p>
                    <p>19 calle 5-47 zona 10 Edificio Unicentro nivel 13 oficina 1302</p>
<p>ejimenez@presta.express</p>
                </div>
            `;
        }

        // Continuar con las dem√°s funciones de generaci√≥n...
        function generarChequeRetenido(datos, fecha) {
            const montoFormateado = formatearMonto(datos.monto || '0');
            const dpiFormateado = formatearDPIDisplay(datos.dpi || '');
            
            return `
                <div class="letter-header">
                    <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
                </div>
                
                <div style="text-align: left; margin-bottom: 30px; margin-top: 100px;">
                    <strong>${fecha}</strong>
                </div>
                
                <div class="letter-body" style="margin-bottom: 60px;">
                    <p><strong>Se√±ores:</strong></p>
                    <p><strong>${datos.empresa || 'PRESTA EXPRESS, SOCIEDAD AN√ìNIMA.'}</strong></p>
                    <p><strong>Presente</strong></p>
                    <p></p>
                    <p><strong>Estimados Se√±ores:</strong></p>
                    <p></p>
                    <p>Dese√°ndoles √©xitos en sus labores diarias, el motivo de la presente es para hacer de su conocimiento que, YO, <strong>${(datos.nombreCompleto || '').toUpperCase()}</strong>, me identifico con el Documento Personal de Identificaci√≥n (DPI) con C√≥digo √önico de Identificaci√≥n (CUI) ${dpiFormateado}, extendido por el Registro Nacional de las Personas, solicito que del cheque retenido n√∫mero <strong>${datos.numeroCheque || ''}</strong> por un monto de <strong>${montoFormateado}</strong> sea trasladado para el saldo de mi cr√©dito.</p>
                    <p></p>
                    <p>Esperando su apoyo y agradecimiento de antemano.</p>
                </div>
                
                <div class="letter-signature" style="margin-top: 100px;">
                    <div class="signature-line"></div>
                    <p><strong>F. ${(datos.nombreCompleto || '').toUpperCase()}</strong></p>
                    <p><strong>DPI ${dpiFormateado}</strong></p>
                </div>
            `;
        }

        // ... continuar con el resto de funciones
        
        // Funciones auxiliares
        function numeroALetrasCompleto(numero) {
            // Implementaci√≥n completa como en el c√≥digo anterior
            if (numero === 0) return 'cero';
            
            const unidades = ['', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
            const decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
            const especiales = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'diecis√©is', 'diecisiete', 'dieciocho', 'diecinueve'];
            const centenas = ['', 'ciento', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];

            if (numero === 100) return 'cien';

            let resultado = '';

            if (numero >= 1000000) {
                const millones = Math.floor(numero / 1000000);
                if (millones === 1) {
                    resultado += 'un mill√≥n ';
                } else {
                    resultado += numeroALetrasCompleto(millones) + ' millones ';
                }
                numero = numero % 1000000;
            }

            if (numero >= 1000) {
                const miles = Math.floor(numero / 1000);
                if (miles === 1) {
                    resultado += 'mil ';
                } else {
                    resultado += numeroALetrasCompleto(miles) + ' mil ';
                }
                numero = numero % 1000;
            }

            if (numero >= 100) {
                resultado += centenas[Math.floor(numero / 100)] + ' ';
                numero = numero % 100;
            }

            if (numero >= 20) {
                resultado += decenas[Math.floor(numero / 10)];
                if (numero % 10 > 0) {
                    resultado += ' y ' + unidades[numero % 10];
                }
            } else if (numero >= 10) {
                resultado += especiales[numero - 10];
            } else if (numero > 0) {
                resultado += unidades[numero];
            }

            return resultado.trim();
        }

        function detectarGenero(nombre) {
            const nombreLimpio = nombre.toLowerCase().trim();
            const primerNombre = nombreLimpio.split(' ')[0];
            
            const nombresFemeninos = [
                'maria', 'ana', 'carmen', 'rosa', 'elena', 'sofia', 'lucia', 'andrea', 
                'sandra', 'patricia', 'claudia', 'monica', 'elizabeth', 'gabriela',
                'alejandra', 'carolina', 'valeria', 'daniela', 'paola', 'laura',
                'martha', 'gloria', 'teresa', 'isabel', 'cristina', 'silvia',
                'beatriz', 'adriana', 'jessica', 'karen', 'michelle', 'stephanie',
                'fernanda', 'mariana', 'rocio', 'veronica', 'leticia', 'nancy',
                'wendy', 'yolanda', 'susana', 'diana', 'lorena', 'emely'
            ];
            
            return nombresFemeninos.includes(primerNombre) ? 'femenino' : 'masculino';
        }

        function formatearMonto(monto) {
            if (monto.toString().includes('Q')) return monto;
            
            const numeroLimpio = monto.toString().replace(/[^\d.]/g, '');
            const numero = parseFloat(numeroLimpio);
            
            if (isNaN(numero)) return monto;
            
            return 'Q' + numero.toLocaleString('es-GT', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatearDPIDisplay(dpi) {
            const soloNumeros = dpi.replace(/\s/g, '');
            if (soloNumeros.length === 13) {
                return soloNumeros.substring(0, 4) + ' ' + soloNumeros.substring(4, 9) + ' ' + soloNumeros.substring(9, 13);
            }
            return dpi;
        }

        // Funciones para generar las dem√°s cartas (implementar todas)
       function generarAutorizacionTransferencia(datos, fecha) {
    const numeroEscrituraEnLetras = numeroALetrasCompleto(parseInt(datos.numeroEscritura || 0));
    const tipoContrato = datos.tipoContrato || 'MUTUO, GARANT√çA HIPOTECARIA';
    const fechaEnLetrasTexto = fechaEnLetras(datos.fecha);
    const genero = detectarGenero(datos.nombreCompleto || '');
    const nacionalidad = genero === 'femenino' ? 'guatemalteca' : 'guatemalteco';
    const estadoCivilAjustado = ajustarEstadoCivil(datos.estadoCivil, genero);
    const numeroCuentaFormateado = '-' + datos.numeroCuenta + '-';
    const dpiFormateado = formatearDPIDisplay(datos.dpi || '');
    
    // Determinar el nombre de la cuenta
    let nombreCuentaFinal = '';
    if (datos.tipoNombreCuenta === 'mismo') {
        nombreCuentaFinal = (datos.nombreCompleto || '').toUpperCase();
    } else if (datos.tipoNombreCuenta === 'otro' && datos.nombreCuenta) {
        nombreCuentaFinal = datos.nombreCuenta.toUpperCase();
    } else {
        nombreCuentaFinal = (datos.nombreCompleto || '').toUpperCase(); // Por defecto
    }
    
    return `
        <div class="letter-header">
            <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
        </div>
        
        <div style="text-align: left; margin-bottom: 30px;">
            <strong>${fecha}</strong>
        </div>
        
        <div class="letter-body" style="margin-bottom: 60px;">
            <p><strong>Se√±ores:</strong></p>
            <p><strong>${datos.empresa || 'HOLLEM, SOCIEDAD AN√ìNIMA.'}</strong></p>
            <p><strong>Presente</strong></p>
            <p></p>
            <p><strong>Estimados Se√±ores:</strong></p>
            <p></p>
            <p>Dese√°ndoles √©xitos en sus labores diarias, el motivo de la presente es para hacer de su conocimiento que, YO, <strong>${(datos.nombreCompleto || '').toUpperCase()}</strong>, de ${datos.edadLetras || ''} a√±os, ${estadoCivilAjustado}, ${nacionalidad}, ${datos.profesion || ''}, de este domicilio, quien me identifico con el Documento Personal de Identificaci√≥n -DPI- con C√≥digo √önico de Identificaci√≥n --CUI-) ${dpiFormateado}, extendido por el Registro Nacional de las Personas; autorizo que del contrato de <strong>${tipoContrato}</strong> realizado por medio de la escritura n√∫mero ${numeroEscrituraEnLetras} (${datos.numeroEscritura || ''}) autorizada en esta ciudad el d√≠a ${fechaEnLetrasTexto} por la notaria ${datos.notario || 'Mar√≠a Olga Arce Godoy'}, se realicen transferencia al n√∫mero de cuenta ${numeroCuentaFormateado} a nombre de <strong>${nombreCuentaFinal}</strong>, cuenta monetaria de ${datos.banco || ''}.</p>
            <p></p>
            <p>Esperando su apoyo y agradecimiento de antemano.</p>
        </div>
        
        <div class="letter-signature" style="margin-top: 80px;">
            <div class="signature-line"></div>
            <p><strong>${(datos.nombreCompleto || '').toUpperCase()}</strong></p>
            <p><strong>${dpiFormateado}</strong></p>
        </div>
    `;
}

        function generarAutorizacionTerceros(datos, fecha) {
            const edadTerceroEnLetras = numeroALetras(parseInt(datos.edadTercero || 0));
            const numeroEscrituraEnLetras = numeroALetrasCompleto(parseInt(datos.numeroEscritura || 0));
const tipoContrato = datos.tipoContrato || 'MUTUO';
            const fechaEnLetrasTexto = fechaEnLetras(datos.fecha);
            const genero = detectarGenero(datos.nombreCompleto || '');
            const generoTercero = detectarGenero(datos.nombreTercero || '');
            const nacionalidad = genero === 'femenino' ? 'guatemalteca' : 'guatemalteco';
            const nacionalidadTercero = generoTercero === 'femenino' ? 'guatemalteca' : 'guatemalteco';
            const estadoCivilAjustado = ajustarEstadoCivil(datos.estadoCivil, genero);
            const estadoCivilTerceroAjustado = ajustarEstadoCivil(datos.estadoCivilTercero, generoTercero);
            const dpiFormateado = formatearDPIDisplay(datos.dpi || '');
            const dpiTerceroFormateado = formatearDPIDisplay(datos.dpiTercero || '');
            
            return `
                <div class="letter-header">
                    <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
                </div>
                
                <div style="text-align: left; margin-bottom: 30px;">
                    <strong>${fecha}</strong>
                </div>
                
                <div class="letter-body" style="margin-bottom: 60px;">
                    <p><strong>Se√±ores:</strong></p>
                    <p><strong>${datos.empresa || 'HOLLEM, SOCIEDAD AN√ìNIMA.'}</strong></p>
                    <p><strong>Presente</strong></p>
                    <p></p>
                    <p><strong>Estimados Se√±ores:</strong></p>
                    <p></p>
                    <p>Dese√°ndoles √©xitos en sus labores diarias, el motivo de la presente es para hacer de su conocimiento que, YO, <strong>${(datos.nombreCompleto || '').toUpperCase()}</strong>, de ${datos.edadLetras || ''} a√±os, ${estadoCivilAjustado}, ${nacionalidad}, ${datos.profesion || ''}, de este domicilio, quien me identifico con el Documento Personal de Identificaci√≥n -DPI- con C√≥digo √önico de Identificaci√≥n --CUI-) ${dpiFormateado}, extendido por el Registro Nacional de las Personas; autorizo que del contrato de <strong>${tipoContrato}</strong> realizado por medio de la escritura n√∫mero ${numeroEscrituraEnLetras} (${datos.numeroEscritura || ''}) autorizada en esta ciudad el d√≠a ${fechaEnLetrasTexto} por la notaria ${datos.notario || 'Mar√≠a Olga Arce Godoy'}, se realicen los cheques a nombre √∫nicamente de <strong>${(datos.nombreTercero || '').toUpperCase()}</strong>, de ${edadTerceroEnLetras} a√±os, ${estadoCivilTerceroAjustado}, ${nacionalidadTercero}, de este domicilio, quien se identifica con el Documento Personal de Identificaci√≥n -DPI- con C√≥digo √önico de Identificaci√≥n --CUI-) ${dpiTerceroFormateado}, extendido por el Registro Nacional de las Personas de la Rep√∫blica de Guatemala.</p>
                    <p></p>
                    <p>Esperando su apoyo y agradecimiento de antemano.</p>
                </div>
                
                <div class="letter-signature" style="margin-top: 80px;">
                    <div style="display: flex; justify-content: space-around; margin-top: 50px;">
                        <div style="text-align: center;">
                            <div style="border-top: 1pt solid #333; width: 250px; margin: 0 auto 10px;"></div>
                            <p><strong>${(datos.nombreCompleto || '').toUpperCase()}</strong></p>
                            <p><strong>${dpiFormateado}</strong></p>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-top: 1pt solid #333; width: 250px; margin: 0 auto 10px;"></div>
                            <p><strong>${(datos.nombreTercero || '').toUpperCase()}</strong></p>
                            <p><strong>${dpiTerceroFormateado}</strong></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generarOrdenesPago(datos, fecha) {
            const monto1 = formatearMonto(datos.montoRetencion1 || '30000');
            const monto2 = formatearMonto(datos.montoRetencion2 || '2000');
            const tipoContrato = datos.tipoContrato || 'MUTUO CON GARANT√çA HIPOTECARIA';
            const fechaDiaMes = fechaSoloDiaMes(datos.fecha);
            
            // Generar retenciones adicionales
            let retencionesHTML = '';
            if (retenciones && retenciones.length > 0) {
                retenciones.forEach((retencion, index) => {
                    if (retencion.nombre && retencion.monto) {
                        const montoFormateado = formatearMonto(retencion.monto);
                        retencionesHTML += `
                            <p></p>
                            <p>${index + 3}. <strong>${retencion.nombre.toUpperCase()}: ${montoFormateado}</strong></p>
                        `;
                    }
                });
            }
            
            return `
                <div class="letter-header">
                    <img src="https://live.staticflickr.com/65535/54530935400_7ccb4446e4.jpg" alt="Presta Express Logo">
                </div>
                
                <div style="text-align: left; margin-bottom: 30px;">
                    <strong>${fecha}</strong>
                </div>
                
                <div class="letter-body">
                    <p><strong>Se√±ores:</strong></p>
                    <p><strong>${datos.empresa || 'HOLLEM, SOCIEDAD AN√ìNIMA.'}</strong></p>
                    <p><strong>Presente</strong></p>
                    <p></p>
                    <p><strong>Estimados Se√±ores:</strong></p>
                    <p></p>
                    <p>Dese√°ndoles √©xitos en sus labores diarias, me permito hacer de su conocimiento que, YO, <strong>${(datos.nombreCompleto || '').toUpperCase()}</strong>, de ${datos.edadLetras || ''} a√±os, ${datos.estadoCivil || ''}, ${datos.nacionalidad || ''}, ${datos.profesion || ''}, de este domicilio, me identifico con el Documento Personal de Identificaci√≥n (DPI) con C√≥digo √önico de Identificaci√≥n (CUI) ${datos.dpi || ''}, extendido por el Registro Nacional de las Personas de la Rep√∫blica de Guatemala.</p>
                    <p></p>
                    <p>En virtud del contrato de <strong>${tipoContrato}</strong>, realizado mediante escritura autorizada en esta ciudad el d√≠a ${fechaDiaMes} por la notaria ${datos.notario || 'Mar√≠a Olga Arce Godoy'}, se me han entregado las √≥rdenes de pago que a continuaci√≥n se detallan, como explicaci√≥n de manera verbal sobre los procesos incluyendo la informaci√≥n sobre como se va realizar el aval√∫o y los tiempos en cada tr√°mite as√≠ poder hacer la entrega de las mismas:</p>
                    <p></p>
                    <p>1. <strong>RETENER HASTA ESTAR INSCRITO EN EL REGISTRO GENERAL DE LA PROPIEDAD Y TENER REALIZADO AVAL√öO CON EMPRESA EXTERNA: ${monto1}</strong></p>
                    <p></p>
                    <p>2. <strong>RETENER HASTA TENER CERTIFICACI√ìN DE NOMENCLATURA REVISADA POR LEGAL: ${monto2}</strong></p>
                    ${retencionesHTML}
                    <p></p>
                    <p>Confirmo que se me est√°n entregando las √≥rdenes de pago, las cuales debo presentar en original cada vez que venga por mis cheques retenidos.</p>
                    <p></p>
                    <p>Agradezco de antemano su apoyo y quedo a la espera de su pronta respuesta.</p>
                    <br>
                    <br>
                    <br>
                    <br>
                </div>
                
                <div class="letter-signature">
                    <div class="signature-line"></div>
                    <p><strong>${(datos.nombreCompleto || '').toUpperCase()}</strong></p>
                    <p><strong>${formatearDPIDisplay(datos.dpi || '')}</strong></p>
                </div>
            `;
        }

        // Funciones auxiliares adicionales
        function ajustarEstadoCivil(estadoCivil, genero) {
            if (!estadoCivil) return '';
            if (genero === 'femenino') {
                switch(estadoCivil.toLowerCase()) {
                    case 'casado': return 'casada';
                    case 'soltero': return 'soltera';
                    case 'divorciado': return 'divorciada';
                    case 'viudo': return 'viuda';
                    default: return estadoCivil;
                }
            }
            return estadoCivil;
        }

        function fechaEnLetras(fecha) {
            if (!fecha) return '';
            
            const meses = [
                'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
            ];
            
            const fechaObj = new Date(fecha + 'T00:00:00');
            const dia = fechaObj.getDate();
            const mes = meses[fechaObj.getMonth()];
            const a√±o = fechaObj.getFullYear();
            
            const diaEnLetras = numeroALetrasCompleto(dia);
            
            return diaEnLetras + ' de ' + mes + ' de ' + a√±o;
        }

        function fechaSoloDiaMes(fecha) {
            if (!fecha) return '';
            
            const meses = [
                'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
            ];
            
            const fechaObj = new Date(fecha + 'T00:00:00');
            const dia = fechaObj.getDate();
            const mes = meses[fechaObj.getMonth()];
            
            const diaEnLetras = numeroALetrasCompleto(dia);
            
            return diaEnLetras + ' de ' + mes;
        }

        // Nueva carta
        function nuevaCarta() {
            // Reset del estado pero mantener datos guardados
            currentStep = 1;
            selectedCarta = '';
            
            // Limpiar copropietarios y retenciones
            copropietarios = [];
            contadorCopropietarios = 0;
            retenciones = [];
            contadorRetenciones = 0;
            
            // Remover selecciones
            document.querySelectorAll('.carta-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('btnSiguiente').disabled = true;
            
            // Ocultar resultado
            document.getElementById('letterOutput').style.display = 'none';
            
            // Volver al paso 1
            cambiarPaso(1);
        }

        // Funciones de impresi√≥n y copia (mantener del c√≥digo anterior)
        function imprimirCarta() {
            const contenido = document.getElementById('letterContent').innerHTML;
            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <html>
                    <head>
                        <title>Carta - Impresi√≥n</title>
                        <style>
                            @page {
                                size: A4;
                                margin: 3cm 2.5cm 2.5cm 2.5cm;
                            }
                            
                            body { 
                                font-family: 'Arial', sans-serif; 
                                font-size: 11pt;
                                line-height: 1.4; 
                                color: #000;
                                margin: 0;
                                padding: 0;
                                background: white;
                            }
                            
                            .letter-header { 
                                text-align: center; 
                                margin-bottom: 25px;
                                font-weight: normal;
                                font-size: 11pt;
                            }
                            
                            .letter-header img {
                                width: 150px;
                                height: auto;
                                margin-bottom: 20px;
                            }
                            
                            .letter-body { 
                                text-align: left; 
                                margin-bottom: 25px;
                                text-indent: 0;
                            }
                            
                            .letter-body p {
                                margin-bottom: 15px;
                                text-align: left;
                                line-height: 1.4;
                                text-indent: 0;
                            }
                            
                            .letter-signature { 
                                margin-top: 40px; 
                                text-align: center; 
                                page-break-inside: avoid;
                                font-size: 11pt;
                            }
                            
                            .signature-line { 
                                border-top: 1pt solid #000; 
                                width: 300px; 
                                margin: 40px auto 12px auto; 
                            }
                            
                            strong {
                                font-weight: bold;
                            }
                            
                            * {
                                color: black !important;
                                background: white !important;
                                border-color: black !important;
                            }
                        </style>
                    </head>
                    <body>${contenido}</body>
                </html>
            `);
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        }

        function copiarCarta() {
            const contenido = document.getElementById('letterContent').innerText;
            navigator.clipboard.writeText(contenido).then(() => {
                alert('Carta copiada al portapapeles');
            });
        }
    </script>
</body>
</html>
